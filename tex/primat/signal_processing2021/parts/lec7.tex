\documentclass[main.tex]{subfiles}
\begin{document}

\section{Лекция 7. Когда не надо применять ML + Видеонаблюдение}
18 марта 2021 г.

\subsection{Попытки применить ML, когда не надо}

Люди (заказчики) думают, что машинное обучение модно, и поэтому пытаются применить его, не понимая, что она лучше и быстрее решается без неё.
Часто такие заказчики не имеют в своей компании соответствующей инфраструктуры, компьютеров, серверов; в итоге тратится много сил, времени и ничего не получается.
В итоге этот заказчик в следующий раз, когда ML действительно может быть полезно, побоится его использовать.

Примеры:

\begin{enumerate}[noitemsep]
    \item в задаче нет семантического разрыва (например, расчёт выручки по известным ценам закупки, продажи и стоимостям обслуживания).
    Важное исключение: инфраструктура позволяет обучить ML быстрее, чем строить точную модель.
    Например, если у нас большая компания (Яндекс) со сложной инфраструктурой, где для расчёта стоимости можно использовать вероятностные модели.
    \item Все объекты в задаче хорошо описываются формулами.

    Машинное обучение пытается подобрать зависимости в данных, когда мы их ещё не видим, описать, что происходит в данных.
    Если формулы заранее известны, вряд ли мы их сделаем точнее.
    Хотя иногда можно, к примеру, сложную формулу аппроксимировать полиномом.
    % TODO ask: алгебраическими формулами и уравнениями? Ведь есть решение ДУ с помощью ML

    \item Нет хороших ML-моделей, которые описывают нашу ситуацию

    % TODO

    \item Трудно получить хорошие данные (это частая ситуация)
    \begin{enumerate}[noitemsep]
        \item Трудности с качественной разметкой: не всегда в открытом доступе есть датасет, подходящий нам; если есть, то не всегда размечено так, как нам нужно.

        Возможно, мы получим подходящий датасет только когда уже запустим сервис, придут пользователи и появятся примеры данных.
        \item Трудности из-за приватных данных: например, мы делаем программу для заказчика, который не хочет давать нам обучающие данные из-за секретности.

        Пример: данные о банковских транзакциях.
        Банк вряд ли может передать нам данные без обфускации.
    \end{enumerate}
    Если нет хороших данных, обучать ML-модель бесмыссленно, потому что она будет работать не лучше, чем эти данные.
    Может быть, имеет смысл отобрать небольшое количество подходящих примеров, построить алгоритм без ML и тестировать на них.

    \item Необходимо понимать принципы работы полученного алгоритма

    В одном дереве можно разобраться, как оно работает; лес решений уже сложно анализировать, вряд ли сможем предсказать выход, глядя на структуру,

    Клиент часто хочет понимать, что как работает.
    Например, приходит клиент в банк и спрашивает, почему заблокировали вполне нормальную банковскую операцию?
    <<ML-модель заблокировала>> -- плохой ответ.
    <<У нас есть решающее правило, основанное на сумме операции и т. д.; сейчас мы его подправим для Вашего случая>> -- ответ хороший.

    \item Большая устойчивость к взламыванию

    Зачастую можно подобрать такое видоизменение входных данных, что ML-модель начнёт на нём ошибаться.
\end{enumerate}

Помимо прочего, задачи применения ML обычно не очень интересные.

\subsection{SHAP-диаграммы}

\href{https://github.com/slundberg/shap}{github.com/slundberg/shap}

Если есть нейронная сеть % TODO

Будет много проблем с метриками качества: сложно вручную определить для большого изображения, насколько хорошо в каждом слое определяются признаки.

Есть способы попытаться модели
Идеологически наиболее правильный способ -- SHAP-модели: на вход подаются признаки, на выходе -- их вклад в ответ ML-системы.
Есть теорема, из которой следует, что SHAP-модели -- наиболее правильный способ описания влияния признаков на ответ.

SHAP-value -- из теории игр.

Для каждого признака $ i $ и каждого примера в данных считаем предсказание на нём с признаком и без признака.
Перебирать все признаки и все данные, конечно, трудоёмко; но, к примеру, в Яндекс SHAP-диаграммы, как правило, строятся для существенной доли обучающей выборки.

\subsection{Обработка видео. Постановка задачи}

\subsubsection{Видео}

Работая с видео, мы предполагаем, что объекты между соседними кадрами изменяются незначительно.

Критерии <<незначительности>> могут варьироваться.

Видео может помочь повысить точность распознавания: можно выбрать наиболее качественный кадр или использовать несколько соседних.
% TODO note for self: матрица гомографии, матрица калибровки; матрица поворота. Можно получить более точные размеры объекта.

\subsubsection{Задачи (на бизнес-уровне)}

Может быть медицинское обследование, навигация по контенту (), поиск по видео...
Задач много!

\subsubsection{Задачи на более низком уровне (формализация)}

\begin{enumerate}[noitemsep]
    \item Выделение <<объектов интереса>>, которые мы описываем какими-то геометрическими примитивами (например, прямоугольниками) или попиксельными масками.
    \item Отслеживание (video tracking): часто имеет смысл отслеживать
    \item Поиск действий (физическое движение человека, взаимодействие объектов -- например, ключ вставлен в замок).
\end{enumerate}

\subsection{Обработка видео. Общие идеи}

В видео есть <<стабильные по виду>> объекты, которые можно отслеживать, и <<атомарные действия>>, котрые можно регистрировать.

\subsubsection{Проблемы}

Вид изменяется от кадра к кадру из-за изменения ракурса, освещения.

Объекты могут накладываться; может быть несколько похожих объектов.

Иногда может быть нестационарное положение камеры (в исследованиях, впрочем, обычно камера зафиксирована жёстко).

\subsubsection{Оценка качества}

% TODO

\subsubsection{Вычитание фона}

Пусть есть объект на фоне.
Можно каким-то способом определить, какие пиксели принадлежат интересующим нам объектам, и вычесть все остальные пиксели из изображения.

\subsubsection{Обработка маски переднего плана} % TODO

\subsubsection{Изменяющийся фон}

В не-лабораторных условиях фон меняется (зависит от времени).

Можно построить график зависимости значений цвета, яркости в пикселях от времени; рассчитать на основе собранных данных

Можно не просто вычитать фон, а подобрать более сложную модель, по которой будем понимать, принадлежит ли пиксель фону (например, объект должен быть намного темнее фона).
Модели с классификациях в отдельных пикселях без контекста работают плохо.
Лучше использовать модели, которые сравнивают соседние пиксели.

\subsubsection{Простейшие модели фона}

Среднее / медиана всех изображений: плохо работает, если много движущихся объектов.

Можно принимать во внимание дисперсию.
Могут играть роль моменты более высокого порядка: третий, четвёртый.

Если в видео постепенно меняется освещённость, можно брать кадры с разными весами; можно строить распределение изменения освещённости.
Пиксели, которые удовлетворяют распределению, будем считать пикселями фона, остальные -- пикселями объектов.

Среди прочих идей: запоминаем, какое изменение вносят базовые объекты (например, включили/выключили лампу), учитываем это в модели.
Для этого можно использовать особые точки.

\subsubsection{Отслеживание объектов}

Пусть в кадре были несколько объектов.
В следующем кадре объекты могут появляться, исчезать и смещаться.

% TODO

\subsubsection{Виды ограничений}

Близость

Вводим максимальную скорость движения

Ожидаем малое изменение

Есть общая картина движения; вероятно,

<<Жёсткость>>: пути следования объектов вероятнее не пересекаются, чем пересекаются.

Как это учитывать?
Можно построить двудольный граф возможных соответствий между объектами в одном и в другом кадре, присвоить рёбрам веса и выбрать какое-то их подмножество.

\subsubsection{Базовый метод видеонаблюдения}

\begin{enumerate}[noitemsep]
    \item Обучаем модель фона
    \item % TODO write from slide
    \begin{enumerate}[noitemsep]
        \item % TODO
        \item обновляем фон, если для этого есть основания.
    \end{enumerate}
\end{enumerate}

Пример -- отслеживание руки с помощью <<стаи точек>>.

\subsection{Обработка видео. Оптический поток}

Когда обнаруживаем руку, считаем, что большая часть точек (фон) не движется.
Бывает, что движутся почти все точки (оптический поток).

Ищем векторное поле движения пикселей между кадрами.

\subsubsection{ Оценка оптического потока. Ограничения }

Будем считать, что яркость постоянная и смещение малое (меньше одного пикселя по каждой оси).

Тогда можно разложить в каждом пикселе картинку как функцию времени в ряд Тейлора:

$ I(x + u, y + v) \approx \frac{\partial x}{den} $ % TODO

Есть алгоритм Лукаса-Канаде -- подбираем значения неизвестных методом наименьших квадратов.

Матрица $ A $ при этом не должна быть плохо обусловленной (в реальности не всегда матрица $ A $ хорошая).
Например, на каждом кадре прямая, проходящая через весь кадр.
Мы не можем понять, сдвинулся ли объект, который обозначает эта прямая, вдоль прямой или нет (уравнение имеет бесконечное количество решений).

Если яркость кадров непостоянная, или соседние точки движутся по-разному, или скорость движения высока -- алгоритм применять не нужно.

\subsubsection{Пример решения задачи: отслеживание положения объекта в реальном времени}

Есть книга; хотим понимать, как меняется её ориентация на видео.

Будем использовать дерево решений.
В каждом узле используем какое-то линейное правило для выбора пути.

Если обучить множество деревьев, их комбинация может работать существенно лучше.
Идея в том, что разбиения можно выбирать, минимизируя ошибку градиентным бустингом, а можно просто с элементами случайности обучить несколько деревьев и использовать их консенсус. Так приходим к алгоритму Random Forest (случайный лес).

Random Forest обучается быстрее, чем градиентный бустинг, и является одним из наиболее распространённых алгоритмов классификации. \\

В нашей задаче можно найти $ N $ особых точек объекта, искать их на изображении и сделать классификатор, который найденным особым точкам будет присваивать номера от $ 0 $ до $ N $ (0 -- если не нашли соответствие).

% TODO a bit

\subsubsection{Yet Another Keypoint Detector}


Особые точки, вероятно, находятся не так точно, как в детекторе Харриса, но зато быстро.

Когда будем искать поворот, необязательно точно находить все особые точки и избегать обнаружения лишних.

\subsubsection{ Синтез данных }

Хотим найти подобрать данные, на которых обучим классификатор исходных точек.
Одного изображения явно недостаточно, чтобы построить хороший случайный лес.

Будем строить трёхмерную модель объекта, приближая объект сеткой.
После этого рендерим новые виды объекта с других ракурсов.

При обучении алгоритма авторы используют два подхода: целевая функция зависит от ошибок классификации

\subsubsection{ Результаты }

Если существенно движется большая часть изображения, надо искать оптический поток.

На изображении можно искать изменяющиеся объекты; пытаться сопоставить их с тем, что мы хотим увидеть (поворот ключа в замочной скважине, проход человека через дверь...)

\subsection{ Организационные моменты }

В отчёте по большой лабораторной хочется увидеть все шаги: постановку и план, какие алгоритмы строили и какие у них были проблемы и как их решали.

Отчёт лучше всего в readme.
Просьба: хорошо написать отчёт, т. к. у Виктора Игоревича нет возможности разбираться во всех реализациях.

Ревью: проект должен собираться и, желательно, корректно отрабатывать на представленном датасете.

Исправления, доделки, доработки можно оставить на средующую итерацию.
Возможны два варианта: получить все ревью, отправить письмо Виктору Игоревичу, получить за это первичные баллы и дальше доделывать + отправлять на второе ревью;

Критерии оценки за реализацию: алгоритм запускается; датасет репрезентативный; подробное описание, почему и как используем то или иное преобразование; дополнительные задачи.

Критерии оценки ревью: ВИ будет оценивать, насколько автор ревью разобрался в том, что происходит.
Просьба не придираться к коду.
Задача ревью -- скорее, не написать чистый код, а ревьюеру научиться понимать чужой код.

Есть возможность оспорить оценку за работу.
Как правило, в прошлые годы это была работа, которая .

\end{document}
